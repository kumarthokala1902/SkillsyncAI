<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillSync - Real-Time Peer Learning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-dark: #6d28d9;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .session-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            background: white;
        }
        
        .session-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .live-indicator {
            animation: pulse 2s infinite;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .video-container {
            background: #000;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
        }
        
        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-placeholder {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: 0.75rem;
            padding: 1rem;
            background: var(--light);
        }
        
        .message {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            max-width: 80%;
        }
        
        .message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.participant {
            background: white;
            border: 1px solid var(--gray-light);
        }
        
        .message.system {
            background: transparent;
            color: var(--gray);
            font-style: italic;
            text-align: center;
            max-width: 100%;
            font-size: 0.85rem;
        }
        
        .participant-video {
            background: var(--dark);
            border-radius: 0.5rem;
            overflow: hidden;
            height: 120px;
            position: relative;
        }
        
        .participant-name {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.6);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: white;
        }
        
        .video-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .control-btn.active {
            background: var(--danger);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }
        
        .btn-success {
            background: var(--secondary);
            border: none;
            border-radius: 0.75rem;
            font-weight: 500;
        }
        
        .tool-card {
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: none;
            overflow: hidden;
        }
        
        .modal-content {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--light);
        }
        
        .participant-item.host {
            background: rgba(124, 58, 237, 0.1);
        }
        
        .floating-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }
        
        .ai-assistant {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ai-response {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .transcript-container {
            background: var(--light);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .document-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .document-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--light);
            transition: all 0.3s ease;
        }
        
        .document-item:hover {
            background: var(--gray-light);
        }
        
        .document-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            font-size: 1.2rem;
        }
        
        .document-icon.pdf {
            background: var(--danger);
        }
        
        .document-icon.doc {
            background: var(--primary);
        }
        
        .document-icon.pptx {
            background: var(--accent);
        }
        
        .document-icon.img {
            background: var(--secondary);
        }
        
        .meet-link-container {
            background: var(--light);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .meet-link {
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 1rem;
        }
        
        .file-upload-area {
            border: 2px dashed var(--gray-light);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--light);
        }
        
        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.1);
        }
        
        @media (max-width: 768px) {
            .chat-messages {
                height: 300px;
            }
            
            .video-placeholder {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand nav-brand" href="/">SkillSync</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i> Dashboard</a>
                <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
            </div>
        </div>
    </nav>

    <!-- Flash Messages Container -->
    <div id="flashMessages"></div>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row">
            <!-- Active Sessions -->
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-white fw-bold">Active Learning Sessions</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                        <i class="fas fa-plus me-2"></i> Start New Session
                    </button>
                </div>

                <!-- AI Assistant -->
                <div class="ai-assistant">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot me-2"></i>
                        <h5 class="mb-0">AI Learning Assistant</h5>
                    </div>
                    <div class="ai-response">
                        <p class="mb-2">I can help you with real-time transcription, translation, and learning support during your sessions.</p>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableAI">
                            <label class="form-check-label" for="enableAI">Enable AI Assistant</label>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions Grid -->
                <div class="row" id="activeSessions">
                    <!-- Sessions will be loaded here dynamically -->
                </div>

                <!-- Video Session Interface (Hidden by default) -->
                <div id="videoSession" class="d-none mt-4">
                    <div class="card tool-card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <h4 class="mb-0 fw-bold" id="sessionTitle">Session Title</h4>
                            <div>
                                <span class="badge bg-danger live-indicator me-2">LIVE</span>
                                <button class="btn btn-danger btn-sm" id="leaveSession">
                                    <i class="fas fa-phone-slash me-1"></i> Leave
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="video-container mb-3" style="height: 350px;">
                                        <video id="localVideo" autoplay muted class="video-element"></video>
                                        <div class="video-controls">
                                            <button class="control-btn" id="toggleVideo">
                                                <i class="fas fa-video"></i>
                                            </button>
                                            <button class="control-btn" id="toggleAudio">
                                                <i class="fas fa-microphone"></i>
                                            </button>
                                            <button class="control-btn" id="toggleScreenShare">
                                                <i class="fas fa-desktop"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row g-2" id="participantVideos">
                                        <!-- Participant videos will appear here -->
                                    </div>
                                    
                                    <!-- Real-time Transcription -->
                                    <div class="transcript-container d-none" id="transcriptContainer">
                                        <h6 class="fw-bold mb-2"><i class="fas fa-comment-dots me-2"></i>Live Transcript</h6>
                                        <div id="transcriptText" class="small"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="chat-container">
                                        <div class="chat-messages mb-3" id="chatMessages">
                                            <div class="message system">
                                                Welcome to the session! Start chatting with participants.
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="chatInput" placeholder="Type a message...">
                                            <button class="btn btn-primary" id="sendMessage">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="card tool-card mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">Session Tools</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="startRecording">
                                <i class="fas fa-record-vinyl me-2"></i> Start Recording
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#shareLinkModal">
                                <i class="fas fa-share-alt me-2"></i> Share Meet Link
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                                <i class="fas fa-file-upload me-2"></i> Upload Document
                            </button>
                        </div>
                        
                        <hr>
                        
                        <h6 class="fw-bold mb-3">Participants</h6>
                        <div id="participantsList">
                            <!-- Participants will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Shared Documents -->
                <div class="card tool-card mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">Shared Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="document-list" id="documentList">
                            <!-- Documents will be loaded here -->
                            <div class="text-center text-muted py-3">
                                No documents shared yet
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Learning Resources -->
                <div class="card tool-card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">Learning Resources</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action">
                                <i class="fas fa-book me-2"></i> Session Notes
                            </a>
                            <a href="#" class="list-group-item list-group-item-action">
                                <i class="fas fa-link me-2"></i> Shared Links
                            </a>
                            <a href="#" class="list-group-item list-group-item-action">
                                <i class="fas fa-download me-2"></i> Download Materials
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Start New Learning Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSessionForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Session Title</label>
                            <input type="text" class="form-control" name="title" placeholder="e.g., Python Study Group" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Topics</label>
                            <input type="text" class="form-control" name="topics" placeholder="e.g., Python, React, Algorithms" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="What will you be learning in this session?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Session Type</label>
                            <select class="form-select" name="sessionType">
                                <option value="study">Study Group</option>
                                <option value="workshop">Workshop</option>
                                <option value="mentoring">One-on-One Mentoring</option>
                                <option value="project">Project Collaboration</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="startSession">Start Session</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div class="modal fade" id="shareLinkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Share Meeting Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Share this link with your friends to join your learning session:</p>
                    <div class="meet-link-container">
                        <div class="meet-link" id="meetLinkText">Generating meet link...</div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="copyMeetLink">
                                <i class="fas fa-copy me-2"></i> Copy Link
                            </button>
                            <button class="btn btn-outline-primary" id="shareViaWhatsapp">
                                <i class="fab fa-whatsapp me-2"></i> Share via WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Document Modal -->
    <div class="modal fade" id="uploadDocumentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Upload Learning Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5 class="mb-2">Drag & Drop Files Here</h5>
                        <p class="text-muted mb-3">or click to browse files</p>
                        <input type="file" id="fileInput" class="d-none" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i> Browse Files
                        </button>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-semibold mb-2">Supported Formats:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary">PDF</span>
                            <span class="badge bg-primary">DOC/DOCX</span>
                            <span class="badge bg-primary">PPT/PPTX</span>
                            <span class="badge bg-primary">TXT</span>
                            <span class="badge bg-primary">JPG/PNG</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSession = null;
        let localStream = null;
        let peer = null;
        let peerConnections = {};
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let isScreenSharing = false;
        let aiEnabled = false;
        let transcriptionEnabled = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let sharedDocuments = [];
        let currentMeetLink = '';

        // WebRTC configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Sample sessions data
        const sampleSessions = [
            {
                id: 1,
                title: "Python Study Group",
                mentor: "Sarah Chen",
                participants: 5,
                topics: "Python, Algorithms",
                description: "Weekly Python study group focusing on algorithms and data structures",
                type: "study"
            },
            {
                id: 2,
                title: "Web Dev Workshop",
                mentor: "David Rodriguez",
                participants: 8,
                topics: "React, JavaScript",
                description: "Hands-on workshop for building modern web applications with React",
                type: "workshop"
            },
            {
                id: 3,
                title: "Data Science Fundamentals",
                mentor: "Alex Kim",
                participants: 3,
                topics: "Python, Pandas, Visualization",
                description: "Learning the basics of data analysis and visualization with Python",
                type: "study"
            }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            setupEventListeners();
            initializeAI();
            initializePeerJS();
        });

        function initializePeerJS() {
            // Initialize PeerJS for real-time communication
            peer = new Peer({
                config: configuration
            });

            peer.on('open', function(id) {
                console.log('PeerJS connected with ID:', id);
                // Store the peer ID for meeting links
                localStorage.setItem('peerId', id);
            });

            peer.on('connection', function(conn) {
                console.log('Incoming connection from:', conn.peer);
                setupConnection(conn);
            });

            peer.on('call', function(call) {
                // Answer the call with our local stream
                call.answer(localStream);
                
                call.on('stream', function(remoteStream) {
                    // Add remote stream to participants
                    addRemoteVideo(remoteStream, call.peer);
                });
            });

            peer.on('error', function(err) {
                console.error('PeerJS error:', err);
                showFlashMessage('Connection error. Please refresh the page.', 'danger');
            });
        }

        function loadSessions() {
            const grid = document.getElementById('activeSessions');
            grid.innerHTML = '';
            
            sampleSessions.forEach(session => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-6 mb-3';
                col.innerHTML = createSessionCard(session);
                grid.appendChild(col);
            });
            
            document.querySelectorAll('.join-session').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = parseInt(this.getAttribute('data-session-id'));
                    joinSession(sessionId);
                });
            });
        }

        function createSessionCard(session) {
            return `
                <div class="card session-card h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title fw-bold">${session.title}</h5>
                            <span class="badge bg-danger live-indicator">LIVE</span>
                        </div>
                        <p class="card-text"><i class="fas fa-user text-primary me-2"></i> ${session.mentor}</p>
                        <p class="card-text"><i class="fas fa-users text-success me-2"></i> ${session.participants} participants</p>
                        <p class="card-text"><i class="fas fa-code text-warning me-2"></i> ${session.topics}</p>
                        <p class="card-text small text-muted mt-auto">${session.description}</p>
                        <button class="btn btn-success mt-auto join-session" data-session-id="${session.id}">
                            <i class="fas fa-video me-2"></i> Join Session
                        </button>
                    </div>
                </div>
            `;
        }

        function setupEventListeners() {
            // Start new session
            document.getElementById('startSession').addEventListener('click', createNewSession);

            // Leave session
            document.getElementById('leaveSession').addEventListener('click', leaveSession);

            // Chat functionality
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });

            // Media controls
            document.getElementById('toggleVideo').addEventListener('click', toggleVideo);
            document.getElementById('toggleAudio').addEventListener('click', toggleAudio);
            document.getElementById('toggleScreenShare').addEventListener('click', toggleScreenShare);

            // AI features
            document.getElementById('enableAI').addEventListener('change', function() {
                aiEnabled = this.checked;
                if (aiEnabled && currentSession) {
                    enableAIFeatures();
                }
            });

            // Recording
            document.getElementById('startRecording').addEventListener('click', toggleRecording);

            // File upload
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            setupFileUploadDropzone();

            // Meet link sharing
            document.getElementById('copyMeetLink').addEventListener('click', copyMeetLink);
            document.getElementById('shareViaWhatsapp').addEventListener('click', shareViaWhatsapp);

            // Generate meet link when modal opens
            document.getElementById('shareLinkModal').addEventListener('show.bs.modal', generateMeetLink);
        }

        function setupFileUploadDropzone() {
            const dropArea = document.getElementById('fileUploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('dragover');
            }
            
            function unhighlight() {
                dropArea.classList.remove('dragover');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            [...files].forEach(uploadFile);
        }

        function handleFileUpload(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function uploadFile(file) {
            if (!validateFile(file)) {
                showFlashMessage(`File type not supported: ${file.name}`, 'danger');
                return;
            }

            // Simulate file upload
            const documentId = Date.now();
            const document = {
                id: documentId,
                name: file.name,
                type: getFileType(file.name),
                size: formatFileSize(file.size),
                uploadTime: new Date().toLocaleTimeString(),
                url: URL.createObjectURL(file) // In real app, this would be server URL
            };

            sharedDocuments.push(document);
            addDocumentToList(document);
            
            // Simulate sharing with other participants
            setTimeout(() => {
                addChatMessage('system', `Document "${file.name}" has been shared`);
            }, 1000);

            showFlashMessage(`"${file.name}" uploaded successfully!`, 'success');
            
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadDocumentModal'));
            if (modal) modal.hide();
        }

        function validateFile(file) {
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'text/plain',
                'image/jpeg',
                'image/jpg',
                'image/png'
            ];
            
            return allowedTypes.includes(file.type) || 
                   file.name.endsWith('.pdf') ||
                   file.name.endsWith('.doc') ||
                   file.name.endsWith('.docx') ||
                   file.name.endsWith('.ppt') ||
                   file.name.endsWith('.pptx') ||
                   file.name.endsWith('.txt') ||
                   file.name.endsWith('.jpg') ||
                   file.name.endsWith('.jpeg') ||
                   file.name.endsWith('.png');
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['ppt', 'pptx'].includes(ext)) return 'pptx';
            if (['jpg', 'jpeg', 'png'].includes(ext)) return 'img';
            return 'txt';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function addDocumentToList(document) {
            const documentList = document.getElementById('documentList');
            
            // Remove empty state if it exists
            const emptyState = documentList.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const documentItem = document.createElement('div');
            documentItem.className = 'document-item';
            documentItem.innerHTML = `
                <div class="document-icon ${document.type}">
                    <i class="fas fa-file-${document.type === 'img' ? 'image' : document.type}"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1 fw-semibold">${document.name}</h6>
                    <small class="text-muted">${document.size} â€¢ ${document.uploadTime}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadDocument('${document.id}')">
                    <i class="fas fa-download"></i>
                </button>
            `;
            
            documentList.appendChild(documentItem);
        }

        function downloadDocument(documentId) {
            const document = sharedDocuments.find(doc => doc.id == documentId);
            if (document) {
                const a = document.createElement('a');
                a.href = document.url;
                a.download = document.name;
                a.click();
                showFlashMessage(`Downloading "${document.name}"`, 'success');
            }
        }

        function generateMeetLink() {
            if (!currentSession) {
                document.getElementById('meetLinkText').textContent = 'Please start a session first';
                return;
            }

            const peerId = localStorage.getItem('peerId');
            if (!peerId) {
                document.getElementById('meetLinkText').textContent = 'Generating connection...';
                setTimeout(generateMeetLink, 1000);
                return;
            }

            // Create a unique meet link
            currentMeetLink = `${window.location.origin}${window.location.pathname}?meet=${peerId}&session=${currentSession.id}`;
            document.getElementById('meetLinkText').textContent = currentMeetLink;
        }

        function copyMeetLink() {
            if (!currentMeetLink) return;
            
            navigator.clipboard.writeText(currentMeetLink).then(() => {
                showFlashMessage('Meet link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentMeetLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showFlashMessage('Meet link copied to clipboard!', 'success');
            });
        }

        function shareViaWhatsapp() {
            if (!currentMeetLink) return;
            
            const text = `Join my learning session: ${currentSession.title}\n\n${currentMeetLink}`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // Check if user joined via meet link
        function checkMeetLinkJoin() {
            const urlParams = new URLSearchParams(window.location.search);
            const meetPeerId = urlParams.get('meet');
            const sessionId = urlParams.get('session');
            
            if (meetPeerId && sessionId) {
                // User joined via meet link - automatically join the session
                const session = sampleSessions.find(s => s.id == sessionId);
                if (session) {
                    setTimeout(() => joinSession(session.id), 1000);
                }
            }
        }

        // Call this function on page load
        checkMeetLinkJoin();

        // Rest of the functions (joinSession, initializeMediaStream, etc.) remain the same
        // from the previous implementation...

        async function joinSession(sessionId) {
            const session = sampleSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            currentSession = session;
            
            // Show video interface
            document.getElementById('activeSessions').classList.add('d-none');
            document.getElementById('videoSession').classList.remove('d-none');
            document.getElementById('sessionTitle').textContent = session.title;
            
            // Initialize media stream
            try {
                await initializeMediaStream();
                await initializeWebRTC();
                loadParticipants();
                addChatMessage('system', `You joined "${session.title}"`);
                showFlashMessage(`Joined ${session.title} successfully!`, 'success');
                
                // Simulate other participants
                simulateParticipants();
            } catch (error) {
                console.error('Error joining session:', error);
                showFlashMessage('Failed to join session. Please check your camera and microphone permissions.', 'danger');
            }
        }

        async function initializeMediaStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                // Enable AI features if selected
                if (aiEnabled) {
                    enableAIFeatures();
                }
            } catch (error) {
                console.error('Error accessing media devices:', error);
                throw error;
            }
        }

        async function initializeWebRTC() {
            // In a real implementation, this would connect to a signaling server
            // and establish peer connections with other participants
            console.log('Initializing WebRTC connections...');
            
            // Simulate peer connections
            setTimeout(() => {
                simulatePeerConnections();
            }, 2000);
        }

        function simulatePeerConnections() {
            // Simulate receiving video streams from other participants
            const participants = ['Sarah Chen', 'Alex Kim', 'Maria Garcia'];
            const container = document.getElementById('participantVideos');
            
            participants.forEach((participant, index) => {
                setTimeout(() => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 mb-2';
                    col.innerHTML = `
                        <div class="participant-video">
                            <div class="video-placeholder">
                                <i class="fas fa-user fa-lg"></i>
                            </div>
                            <div class="participant-name">${participant}</div>
                            <div class="video-controls">
                                <button class="control-btn btn-sm">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                    
                    addChatMessage('system', `${participant} joined the session`);
                }, (index + 1) * 1000);
            });
        }

        function loadParticipants() {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            // Add yourself
            const youItem = document.createElement('div');
            youItem.className = 'participant-item host';
            youItem.innerHTML = `
                <i class="fas fa-user-circle text-primary me-2"></i>
                <span class="fw-semibold">You</span>
                <span class="badge bg-primary ms-auto">Host</span>
            `;
            list.appendChild(youItem);
            
            // Add simulated participants
            const participants = ['Sarah Chen', 'Alex Kim', 'Maria Garcia', 'David Rodriguez'];
            participants.forEach(participant => {
                const participantItem = document.createElement('div');
                participantItem.className = 'participant-item';
                participantItem.innerHTML = `
                    <i class="fas fa-user-circle text-success me-2"></i>
                    <span>${participant}</span>
                    <span class="badge bg-success ms-auto">Joined</span>
                `;
                list.appendChild(participantItem);
            });
        }

        function simulateParticipants() {
            // Simulate real-time participant activity
            setInterval(() => {
                if (Math.random() > 0.7 && currentSession) {
                    const messages = [
                        "Can someone explain that concept again?",
                        "I found this helpful resource...",
                        "Does anyone have experience with this?",
                        "Great session everyone!",
                        "I'll share my screen to show my approach"
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    const participants = ['Sarah Chen', 'Alex Kim', 'Maria Garcia'];
                    const randomParticipant = participants[Math.floor(Math.random() * participants.length)];
                    
                    addChatMessage('participant', randomMessage, randomParticipant);
                }
            }, 8000);
        }

        function createNewSession() {
            const form = document.getElementById('createSessionForm');
            const formData = new FormData(form);
            
            if (!formData.get('title') || !formData.get('topics')) {
                showFlashMessage('Please fill in all required fields', 'danger');
                return;
            }
            
            const newSession = {
                id: Date.now(),
                title: formData.get('title'),
                mentor: 'You',
                participants: 1,
                topics: formData.get('topics'),
                description: formData.get('description') || 'No description provided',
                type: formData.get('sessionType')
            };
            
            sampleSessions.unshift(newSession);
            loadSessions();
            
            bootstrap.Modal.getInstance(document.getElementById('createSessionModal')).hide();
            form.reset();
            
            // Auto-join the new session
            setTimeout(() => joinSession(newSession.id), 500);
            showFlashMessage(`"${newSession.title}" started successfully!`, 'success');
        }

        function leaveSession() {
            if (!currentSession) return;
            
            // Stop all media streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Close peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            // Reset UI
            document.getElementById('activeSessions').classList.remove('d-none');
            document.getElementById('videoSession').classList.add('d-none');
            document.getElementById('participantsList').innerHTML = '';
            document.getElementById('participantVideos').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = '<div class="message system">Welcome to the session! Start chatting with participants.</div>';
            
            addChatMessage('system', 'You left the session');
            showFlashMessage(`Left ${currentSession.title}`, 'info');
            
            currentSession = null;
        }

        function toggleVideo() {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                isVideoEnabled = videoTrack.enabled;
                
                const btn = document.getElementById('toggleVideo');
                if (isVideoEnabled) {
                    btn.innerHTML = '<i class="fas fa-video"></i>';
                    btn.classList.remove('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                    btn.classList.add('active');
                }
            }
        }

        function toggleAudio() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isAudioEnabled = audioTrack.enabled;
                
                const btn = document.getElementById('toggleAudio');
                if (isAudioEnabled) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    btn.classList.remove('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    btn.classList.add('active');
                }
            }
        }

        async function toggleScreenShare() {
            if (!isScreenSharing) {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const localVideo = document.getElementById('localVideo');
                    
                    // Replace the video track
                    const sender = getVideoSender();
                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }
                    
                    localVideo.srcObject = screenStream;
                    isScreenSharing = true;
                    
                    document.getElementById('toggleScreenShare').classList.add('active');
                    addChatMessage('system', 'You started screen sharing');
                    
                    // Handle when screen sharing stops
                    videoTrack.onended = () => {
                        toggleScreenShare();
                    };
                } catch (error) {
                    console.error('Error sharing screen:', error);
                }
            } else {
                // Switch back to camera
                try {
                    const cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    const videoTrack = cameraStream.getVideoTracks()[0];
                    const sender = getVideoSender();
                    
                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }
                    
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = cameraStream;
                    isScreenSharing = false;
                    
                    document.getElementById('toggleScreenShare').classList.remove('active');
                    addChatMessage('system', 'You stopped screen sharing');
                } catch (error) {
                    console.error('Error switching to camera:', error);
                }
            }
        }

        function getVideoSender() {
            // In a real implementation, this would get the RTCPeerConnection video sender
            return null;
        }

        async function initializeAI() {
            try {
                // Initialize Hugging Face transformers for AI features
                console.log('Initializing AI features...');
                
                // This would load models for transcription, translation, etc.
                // For demo purposes, we'll simulate AI responses
                
            } catch (error) {
                console.error('Error initializing AI:', error);
            }
        }

        function enableAIFeatures() {
            if (!aiEnabled) return;
            
            // Enable real-time transcription
            transcriptionEnabled = true;
            document.getElementById('transcriptContainer').classList.remove('d-none');
            
            // Simulate AI transcription
            simulateTranscription();
            
            showFlashMessage('AI Assistant enabled! Real-time transcription active.', 'success');
        }

        function simulateTranscription() {
            if (!transcriptionEnabled || !currentSession) return;
            
            const transcriptText = document.getElementById('transcriptText');
            const phrases = [
                "Let's start by reviewing the basic concepts...",
                "Does anyone have questions about the previous topic?",
                "I think we should focus on practical examples next",
                "The key point to remember is that algorithms help us solve problems efficiently",
                "Let me share a code example to demonstrate this concept"
            ];
            
            setInterval(() => {
                if (Math.random() > 0.5) {
                    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                    const timestamp = new Date().toLocaleTimeString();
                    transcriptText.innerHTML += `<div><strong>${timestamp}:</strong> ${randomPhrase}</div>`;
                    transcriptText.scrollTop = transcriptText.scrollHeight;
                }
            }, 10000);
        }

        function toggleRecording() {
            const btn = document.getElementById('startRecording');
            
            if (!mediaRecorder) {
                // Start recording
                if (localStream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(localStream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `session-recording-${Date.now()}.webm`;
                        a.click();
                    };
                    
                    mediaRecorder.start();
                    btn.innerHTML = '<i class="fas fa-stop me-2"></i> Stop Recording';
                    btn.classList.add('btn-danger');
                    addChatMessage('system', 'Recording started');
                }
            } else {
                // Stop recording
                mediaRecorder.stop();
                mediaRecorder = null;
                btn.innerHTML = '<i class="fas fa-record-vinyl me-2"></i> Start Recording';
                btn.classList.remove('btn-danger');
                addChatMessage('system', 'Recording stopped and saved');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && currentSession) {
                addChatMessage('user', message);
                input.value = '';
                
                // Simulate AI responses for learning-related messages
                if (aiEnabled && isLearningRelated(message)) {
                    setTimeout(() => {
                        const aiResponse = generateAIResponse(message);
                        addChatMessage('participant', aiResponse, 'AI Assistant');
                    }, 1500);
                }
                
                // Simulate participant responses
                setTimeout(() => {
                    const responses = [
                        "That's a great question!",
                        "I agree with that point.",
                        "Could you explain that further?",
                        "Let me share my screen to demonstrate.",
                        "Does anyone else have thoughts on this?",
                        "I found this resource helpful for that topic."
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const participants = ['Sarah Chen', 'Alex Kim', 'Maria Garcia'];
                    const randomParticipant = participants[Math.floor(Math.random() * participants.length)];
                    addChatMessage('participant', randomResponse, randomParticipant);
                }, 1000 + Math.random() * 2000);
            }
        }

        function isLearningRelated(message) {
            const learningKeywords = ['learn', 'teach', 'explain', 'how to', 'what is', 'help', 'understand', 'concept'];
            return learningKeywords.some(keyword => message.toLowerCase().includes(keyword));
        }

        function generateAIResponse(message) {
            const responses = {
                'learn': "I can help you learn that! Here are some key points to get started...",
                'explain': "Let me break that down for you. The main concept is...",
                'help': "I'd be happy to help! What specific aspect are you struggling with?",
                'understand': "To better understand this, let's look at a practical example...",
                'default': "That's an interesting question! Based on my knowledge, I recommend focusing on the fundamentals first."
            };
            
            for (const [keyword, response] of Object.entries(responses)) {
                if (message.toLowerCase().includes(keyword)) {
                    return response;
                }
            }
            
            return responses.default;
        }

        function addChatMessage(type, content, participantName = 'Participant') {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            if (type === 'user') {
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `<strong>You:</strong> ${content}`;
            } else if (type === 'participant') {
                messageDiv.className = 'message participant';
                messageDiv.innerHTML = `<strong>${participantName}:</strong> ${content}`;
            } else {
                messageDiv.className = 'message system';
                messageDiv.innerHTML = content;
            }
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function showFlashMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show floating-alert`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.getElementById('flashMessages').appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>